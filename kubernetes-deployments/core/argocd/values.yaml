argo-cd:
  enabled: true
  configs:
    params:
      server.insecure: "true"
      applicationsetcontroller.enable.policy.override: true
    secret:
      createSecret: false
  server:
    env:
      - name: TZ
        value: America/New_York
    resources:
      limits:
        cpu: 100m
        memory: 128Mi
      requests:
        cpu: 10m
        memory: 48Mi
    ingress:
      enabled: true
      annotations:
        cert-manager.io/cluster-issuer: lets-encrypt-production
        external-dns.alpha.kubernetes.io/alias: "true"
        ingress.kubernetes.io/force-ssl-redirect: "true"
        ingress.kubernetes.io/protocol: http
        kubernetes.io/ingress.class: traefik
        kubernetes.io/tls-acme: "true"
        traefik.ingress.kubernetes.io/router.entrypoints: websecure
        traefik.ingress.kubernetes.io/router.middlewares: traefik-default-security@kubernetescrd
        traefik.ingress.kubernetes.io/router.tls.options: traefik-default-tls@kubernetescrd
        traefik.ingress.kubernetes.io/router.tls: "true"
      hostname: &domain argocd.jsnouff.net
      tls:
        - secretName: tls-secret
          hosts:
            - *domain
  controller:
    resources:
      limits:
        cpu: 1250m
        memory: 1024Mi
      requests:
        cpu: 250m
        memory: 256Mi
  repoServer:
    env:
      - name: TZ
        value: America/New_York
    resources:
      limits:
        cpu: 2000m
        memory: 512Mi
      requests:
        cpu: 150m
        memory: 128Mi
  applicationSet:
    enabled: true
    resources:
      limits:
        cpu: 500m
        memory: 128Mi
      requests:
        cpu: 50m
        memory: 48Mi
  redis:
    enabled: true
    env:
      - name: TZ
        value: America/New_York
    resources:
      limits:
        cpu: 200m
        memory: 128Mi
      requests:
        cpu: 10m
        memory: 24Mi
  notifications:
    enabled: false
  dex:
    enabled: false

argocd-apps:
  enabled: true
  projects:
    - name: applications
      description: Generic project for applications
      finalizers: &app-projects-finalizers
        - resources-finalizer.argocd.argoproj.io
      sourceRepos: &app-projects-source-repos
        - '*'
      destinations: &app-projects-destinations
        - namespace: '*'
          server: '*'
      clusterResourceWhitelist: &app-projects-cluster-resource-whitelist
        - group: '*'
          kind: '*'
      namespaceResourceWhitelist: &app-projects-ns-resource-whitelist
        - group: '*'
          kind: '*'
    - name: automation
      description: Project for automation deployments
      finalizers: *app-projects-finalizers
      sourceRepos: *app-projects-source-repos
      destinations: *app-projects-destinations
      clusterResourceWhitelist: *app-projects-cluster-resource-whitelist
      namespaceResourceWhitelist: *app-projects-ns-resource-whitelist
    - name: core
      description: Project for core services
      finalizers: *app-projects-finalizers
      sourceRepos: *app-projects-source-repos
      destinations: *app-projects-destinations
      clusterResourceWhitelist: *app-projects-cluster-resource-whitelist
      namespaceResourceWhitelist: *app-projects-ns-resource-whitelist
    - name: media
      description: Project for media services
      finalizers: *app-projects-finalizers
      sourceRepos: *app-projects-source-repos
      destinations: *app-projects-destinations
      clusterResourceWhitelist: *app-projects-cluster-resource-whitelist
      namespaceResourceWhitelist: *app-projects-ns-resource-whitelist
    - name: storage
      description: Project for storage services
      finalizers: []
      sourceRepos: *app-projects-source-repos
      destinations: *app-projects-destinations
      clusterResourceWhitelist: *app-projects-cluster-resource-whitelist
      namespaceResourceWhitelist: *app-projects-ns-resource-whitelist
  applicationsets:
  - name: applications
    goTemplate: true
    generators:
    - git:
        repoURL: &gitops-repo-url git@github.com:jsnouffer/homelab.git
        revision: &gitops-repo-revision HEAD
        directories:
        - path: kubernetes-deployments/applications/*
    template:
      metadata:
        name: '{{ base .path.path }}'
        labels: {}
        annotations:
          argocd.argoproj.io/manifest-generate-paths: .

          argocd-image-updater.argoproj.io/write-back-method: git
          argocd-image-updater.argoproj.io/git-branch: main:image-updater-{{`{{.SHA256}}`}}
          argocd-image-updater.argoproj.io/image-list: linkding=sissbruecker/linkding

          argocd-image-updater.argoproj.io/linkding.helm.image-name: linkding.controllers.main.containers.main.image.repository
          argocd-image-updater.argoproj.io/linkding.helm.image-tag: linkding.controllers.main.containers.main.image.tag
      spec:
        project: applications
        source:
          repoURL: *gitops-repo-url
          targetRevision: *gitops-repo-revision
          path: '{{ .path.path }}'
          helm: &appsets-helm
            valueFiles:
              - values.yaml
        destination: &appsets-destination
          server: https://kubernetes.default.svc
          namespace: '{{ base .path.path }}'
        revisionHistoryLimit: 5
        syncPolicy:
          syncOptions: &appsets-sync-options
            - ApplyOutOfSyncOnly=true
            - CreateNamespace=true
            - RespectIgnoreDifferences=true
            - PruneLast=true
        ignoreDifferences: []
    syncPolicy:
      preserveResourcesOnDeletion: true
      applicationsSync: sync
  - name: automation
    goTemplate: true
    generators:
    - git:
        repoURL: *gitops-repo-url
        revision: *gitops-repo-revision
        directories:
        - path: kubernetes-deployments/automation/*
    template:
      metadata:
        name: '{{ base .path.path }}'
        labels: {}
        annotations:
          argocd.argoproj.io/manifest-generate-paths: .
      spec:
        project: automation
        source:
          repoURL: *gitops-repo-url
          targetRevision: *gitops-repo-revision
          path: '{{ .path.path }}'
          helm: *appsets-helm
        destination: *appsets-destination
        revisionHistoryLimit: 5
        syncPolicy:
          syncOptions: *appsets-sync-options
        ignoreDifferences: []
    syncPolicy:
      preserveResourcesOnDeletion: true
      applicationsSync: sync
  - name: core
    goTemplate: true
    generators:
    - git:
        repoURL: *gitops-repo-url
        revision: *gitops-repo-revision
        directories:
        - path: kubernetes-deployments/core/*
    template:
      metadata:
        name: '{{ base .path.path }}'
        labels: {}
        annotations:
          argocd.argoproj.io/manifest-generate-paths: .

          argocd-image-updater.argoproj.io/write-back-method: git
          argocd-image-updater.argoproj.io/git-branch: main:image-updater-{{`{{.SHA256}}`}}
          argocd-image-updater.argoproj.io/image-list: cf=cloudflare/cloudflared

          argocd-image-updater.argoproj.io/cf.helm.image-name: cloudflare-tunnel.controllers.main.containers.main.image.repository
          argocd-image-updater.argoproj.io/cf.helm.image-tag: cloudflare-tunnel.controllers.main.containers.main.image.tag
      spec:
        project: core
        source:
          repoURL: *gitops-repo-url
          targetRevision: *gitops-repo-revision
          path: '{{ .path.path }}'
          helm: *appsets-helm
        destination: *appsets-destination
        revisionHistoryLimit: 5
        syncPolicy:
          syncOptions: *appsets-sync-options
          automated:
            prune: false
            selfHeal: true
        ignoreDifferences: []
    syncPolicy:
      preserveResourcesOnDeletion: true
      applicationsSync: sync
  - name: media
    goTemplate: true
    generators:
    - git:
        repoURL: *gitops-repo-url
        revision: *gitops-repo-revision
        directories:
        - path: kubernetes-deployments/media/*
    template:
      metadata:
        name: '{{ base .path.path }}'
        labels: {}
        annotations:
          argocd.argoproj.io/manifest-generate-paths: .
      spec:
        project: media
        source:
          repoURL: *gitops-repo-url
          targetRevision: *gitops-repo-revision
          path: '{{ .path.path }}'
          helm: *appsets-helm
        destination: *appsets-destination
        revisionHistoryLimit: 5
        syncPolicy:
          syncOptions: *appsets-sync-options
        ignoreDifferences: []
    syncPolicy:
      preserveResourcesOnDeletion: true
      applicationsSync: sync
  - name: storage
    goTemplate: true
    generators:
    - git:
        repoURL: *gitops-repo-url
        revision: *gitops-repo-revision
        directories:
        - path: kubernetes-deployments/storage/*
    template:
      metadata:
        name: '{{ base .path.path }}'
        labels: {}
        annotations:
          argocd.argoproj.io/manifest-generate-paths: .
      spec:
        project: storage
        source:
          repoURL: *gitops-repo-url
          targetRevision: *gitops-repo-revision
          path: '{{ .path.path }}'
          helm: *appsets-helm
        destination: *appsets-destination
        revisionHistoryLimit: 5
        syncPolicy:
          syncOptions: *appsets-sync-options
        ignoreDifferences: []
    syncPolicy:
      preserveResourcesOnDeletion: true
      applicationsSync: create-update

argocd-image-updater:
  enabled: true
  fullnameOverride: argocd-image-updater
  extraEnv:
    - name: TZ
      value: America/New_York
  config:
    argocd:
      insecure: true
      plaintext: true
    gitCommitUser: "Argo Image Updater"
    gitCommitMail: "jsnouff+argoimage@gmail.com"
    logLevel: "debug"