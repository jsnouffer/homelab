---
apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: sharedvolumes
spec:
  compositeTypeRef:
    apiVersion: jsnouff.net/v1alpha1
    kind: SharedVolume
  mode: Pipeline
  pipeline:
    - step: apply-base-pvc
      functionRef:
        name: function-patch-and-transform
      input:
        apiVersion: pt.fn.crossplane.io/v1beta1
        kind: Resources
        resources:
          - name: base-pvc
            base:
              apiVersion: kubernetes.m.crossplane.io/v1alpha1
              kind: Object
              spec:
                forProvider:
                  manifest:
                    apiVersion: v1
                    kind: PersistentVolumeClaim
                    spec:
                      accessModes:
                        - ReadWriteMany
                      volumeMode: Filesystem
                providerConfigRef:
                  kind: ClusterProviderConfig
                  name: kubernetes-provider
            patches:
              - fromFieldPath: metadata.name
                toFieldPath: metadata.name
                transforms:
                  - type: string
                    string:
                      type: Format
                      fmt: "sharedvolume-base-pvc-%s"
              - fromFieldPath: metadata.name
                toFieldPath: spec.forProvider.manifest.metadata.name
                transforms:
                  - type: string
                    string:
                      type: Format
                      fmt: "sharedvolume-base-pvc-%s"
              - fromFieldPath: spec.storageTemplate.namespace
                toFieldPath: metadata.namespace
              - fromFieldPath: spec.storageTemplate.namespace
                toFieldPath: spec.forProvider.manifest.metadata.namespace
              - fromFieldPath: spec.storageTemplate.size
                toFieldPath: spec.forProvider.manifest.spec.resources.requests.storage
              - fromFieldPath: spec.storageTemplate.storageClassName
                toFieldPath: spec.forProvider.manifest.spec.storageClassName
              - fromFieldPath: spec.storageTemplate.deletionProtection
                toFieldPath: metadata.finalizers
                transforms:
                  - type: string
                    string:
                      type: Format
                      fmt: "%t"
                  - type: match
                    match:
                      patterns:
                        - type: literal
                          literal: "true"
                          result: ["finalizer.sharedvolume.deletionprotection"]
          - name: observe-base-pv
            base:
              apiVersion: kubernetes.crossplane.io/v1alpha2
              kind: Object
              spec:
                forProvider:
                  manifest:
                    apiVersion: v1
                    kind: PersistentVolume
                managementPolicies:
                - Observe
                providerConfigRef:
                  name: kubernetes-provider
                references:
                  - patchesFrom:
                      apiVersion: v1
                      kind: PersistentVolumeClaim
                      fieldPath: spec.volumeName
                    toFieldPath: metadata.name
            patches:
              - fromFieldPath: metadata.name
                toFieldPath: metadata.name
                transforms:
                  - type: string
                    string:
                      type: Format
                      fmt: "sharedvolume-base-pv-%s"
              - fromFieldPath: metadata.name
                toFieldPath: spec.references[0].patchesFrom.name
                transforms:
                  - type: string
                    string:
                      type: Format
                      fmt: "sharedvolume-base-pvc-%s"
              - fromFieldPath: spec.storageTemplate.namespace
                toFieldPath: spec.references[0].patchesFrom.namespace
    - step: apply-shared-pvs
      functionRef:
        name: function-python
      input:
        apiVersion: python.fn.crossplane.io/v1beta1
        kind: Script
        script: |
          {{- .Files.Get "files/apply-pv-objects.py" | nindent 10 }}
    - step: apply-shared-pvcs
      functionRef:
        name: function-python
      input:
        apiVersion: python.fn.crossplane.io/v1beta1
        kind: Script
        script: |
          {{- .Files.Get "files/apply-pvc-objects.py" | nindent 10 }}